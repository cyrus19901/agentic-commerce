openapi: 3.1.0
info:
  title: Unified Agentic Commerce API
  description: |
    API for AI agents supporting BOTH agent-to-merchant AND agent-to-agent transactions.
    
    ## üéØ Two Transaction Types:
    
    ### 1Ô∏è‚É£ Agent-to-Merchant (Traditional E-commerce)
    - Buy products from merchants/stores
    - Traditional checkout flow with Stripe
    - Policy enforcement (budget, merchant, category rules)
    
    ### 2Ô∏è‚É£ Agent-to-Agent (Micropayments via x402)
    - Request services from other AI agents
    - Pay with Solana USDC micropayments
    - x402 protocol (HTTP 402 Payment Required)
    - Policy enforcement (budget, agent whitelist, service limits)
    
    ## üîê Authentication Flow:
    
    1. Call `createUser` with email
    2. Call `generateToken` to get JWT
    3. Use token in Authorization header for all requests
    
    ## üìã Agent-to-Merchant Workflow:
    
    1. Search products: `POST /api/products/search`
    2. Check policy: `POST /api/policy/check` (transactionType: "agent-to-merchant")
    3. If allowed, checkout: `POST /api/checkout/initiate`
    4. Complete purchase: `POST /api/checkout/complete`
    
    ## ü§ñ Agent-to-Agent Workflow:
    
    1. Discover agents: `GET /api/registry/agents`
    2. Check policy: `POST /api/policy/check` (transactionType: "agent-to-agent")
    3. Request service: `POST /api/agent/services/{serviceType}` ‚Üí Returns 402 with payment requirement
    4. Submit payment proof: `POST /api/agent/services/{serviceType}` with x402PaymentProof
    5. Receive service response
    
    ## üé® Example Use Cases:
    
    **Agent-to-Merchant:**
    - "Buy a laptop from Amazon"
    - "Order office supplies from Staples"
    - "Purchase headphones under $200"
    
    **Agent-to-Agent:**
    - "Use web scraping service to extract data"
    - "Call API service to fetch weather data"
    - "Request analytics service for report generation"
    
    ## üìä Policy Engine:
    
    All transactions (both types) go through policy checks:
    - Budget limits (per transaction type)
    - Whitelist/blacklist (merchants OR agents)
    - Time restrictions
    - Amount limits
    - Approval requirements
    
  version: 2.0.0
servers:
  - url: http://localhost:3000
    description: Docker container (recommended for testing)
  - url: https://agentic-commerce-api-latest.onrender.com
    description: Production server

paths:
  # ========================================
  # AUTHENTICATION ENDPOINTS
  # ========================================
  
  /api/auth/create-user:
    post:
      operationId: createUser
      summary: Create user account
      description: |
        Create new user or retrieve existing. Call this FIRST.
        No authentication required.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: "agent@example.com"
                name:
                  type: string
                  example: "Shopping Agent"
      responses:
        '200':
          description: User created/retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      name:
                        type: string
                  message:
                    type: string

  /api/auth/generate-token:
    post:
      operationId: generateToken
      summary: Generate JWT token
      description: |
        Generate authentication token. Call AFTER createUser.
        Use returned token in Authorization header as "Bearer {token}".
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: "agent@example.com"
      responses:
        '200':
          description: Token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  token:
                    type: string
                    description: JWT token - use in Authorization header
                  userId:
                    type: string
                  email:
                    type: string

  # ========================================
  # AGENT-TO-MERCHANT ENDPOINTS
  # ========================================

  /api/products/search:
    post:
      operationId: searchProducts
      summary: Search merchant products
      description: |
        Search for products from merchants (agent-to-merchant).
        Available categories: Office Supplies, Electronics, Bags & Purses, Travel.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
                  example: "agent@example.com"
                query:
                  type: string
                  example: "laptop"
                max_price:
                  type: number
                category:
                  type: string
                limit:
                  type: integer
                  default: 10
      responses:
        '200':
          description: Product results
          content:
            application/json:
              schema:
                type: object
                properties:
                  products:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        title:
                          type: string
                        price:
                          type: number
                        merchant:
                          type: string
                        category:
                          type: string
                        imageUrl:
                          type: string

  /api/checkout/initiate:
    post:
      operationId: initiateCheckout
      summary: Start merchant checkout
      description: |
        Create checkout session for merchant product.
        Returns checkout URL (Stripe or mock).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - product_id
                - amount
                - product_name
                - merchant
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
                product_id:
                  type: string
                product_name:
                  type: string
                amount:
                  type: number
                merchant:
                  type: string
                category:
                  type: string
      responses:
        '200':
          description: Checkout session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  checkout_session_id:
                    type: string
                  checkout_url:
                    type: string
                  expires_at:
                    type: string

  # ========================================
  # AGENT-TO-AGENT ENDPOINTS (NEW!)
  # ========================================

  /api/registry/agents:
    get:
      operationId: listAgents
      summary: Discover available agents
      description: |
        List all registered AI agents offering services.
        Use this to discover which agent services are available.
        No authentication required for discovery.
      security: []
      parameters:
        - name: service
          in: query
          schema:
            type: string
          description: Filter by service type (e.g., "scrape", "api-call")
        - name: active
          in: query
          schema:
            type: boolean
          description: Filter by active status
      responses:
        '200':
          description: List of agents
          content:
            application/json:
              schema:
                type: object
                properties:
                  agents:
                    type: array
                    items:
                      type: object
                      properties:
                        agentId:
                          type: string
                          example: "agent://scraper.service/v1"
                        name:
                          type: string
                          example: "Web Scraper Service"
                        baseUrl:
                          type: string
                        services:
                          type: array
                          items:
                            type: string
                          example: ["scrape", "extract"]
                        serviceDescription:
                          type: string
                        acceptedCurrencies:
                          type: array
                          items:
                            type: string
                          example: ["USDC"]
                        active:
                          type: boolean
                        verified:
                          type: boolean
                  count:
                    type: integer

    post:
      operationId: registerAgent
      summary: Register new agent service
      description: |
        Register your AI agent to offer services to other agents.
        Requires authentication.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agentId
                - name
                - baseUrl
                - services
              properties:
                agentId:
                  type: string
                  example: "agent://my-service/v1"
                  description: Unique agent identifier (URI format)
                name:
                  type: string
                  example: "My AI Service"
                baseUrl:
                  type: string
                  example: "http://localhost:4000"
                services:
                  type: array
                  items:
                    type: string
                  example: ["scrape", "api-call"]
                serviceDescription:
                  type: string
                  example: "Web scraping and data extraction"
                acceptedCurrencies:
                  type: array
                  items:
                    type: string
                  default: ["USDC"]
                usdcTokenAccount:
                  type: string
                  description: Solana USDC token account address
                solanaPubkey:
                  type: string
                  description: Solana public key
      responses:
        '200':
          description: Agent registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  agent:
                    type: object

  /api/registry/agents/{agentId}:
    get:
      operationId: getAgent
      summary: Get agent details
      description: Get specific agent information
      security: []
      parameters:
        - name: agentId
          in: path
          required: true
          schema:
            type: string
          description: Agent ID (URL-encoded, e.g., agent%3A%2F%2Fscraper%2Fv1)
      responses:
        '200':
          description: Agent details
          content:
            application/json:
              schema:
                type: object

  /api/agent/services/{serviceType}:
    post:
      operationId: requestAgentService
      summary: Request agent service (x402 flow)
      description: |
        Request service from an AI agent. This uses x402 protocol:
        
        **First Request (no payment):**
        - Returns HTTP 402 with payment requirement
        - Includes x402Requirement object with payment details
        
        **Second Request (with payment):**
        - Include x402PaymentProof in request body
        - Returns actual service response
        
        **Note:** This endpoint checks policies automatically before processing.
      parameters:
        - name: serviceType
          in: path
          required: true
          schema:
            type: string
          example: "scrape"
          description: Service type (scrape, api-call, analytics, etc.)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                # Service-specific parameters (varies by service)
                url:
                  type: string
                  description: For scraping services
                  example: "https://example.com"
                endpoint:
                  type: string
                  description: For API call services
                data:
                  type: object
                  description: Service-specific data
                
                # x402 payment proof (include in second request)
                x402PaymentProof:
                  type: object
                  description: Payment proof from Solana transaction
                  properties:
                    protocol:
                      type: string
                      example: "x402"
                    version:
                      type: string
                      example: "v2"
                    txSignature:
                      type: string
                      description: Solana transaction signature
                    mint:
                      type: string
                      description: Token mint address (USDC)
                    amount:
                      type: string
                      description: Amount in smallest unit
                    payTo:
                      type: string
                      description: Recipient address
                    nonce:
                      type: string
                      description: Unique nonce from requirement
                    network:
                      type: string
                      example: "devnet"
                    bodyHash:
                      type: string
                      description: SHA256 hash of request body
      responses:
        '402':
          description: Payment Required (first request)
          headers:
            PAYMENT-REQUIRED:
              schema:
                type: string
              description: Base64-encoded x402 requirement
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "PAYMENT_REQUIRED"
                  requirement:
                    type: object
                    description: x402 payment requirement details
                    properties:
                      protocol:
                        type: string
                      version:
                        type: string
                      amount:
                        type: string
                      nonce:
                        type: string
                      payTo:
                        type: string
                      mint:
                        type: string
                      network:
                        type: string
                      bodyHash:
                        type: string
        '200':
          description: Service response (after payment)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  data:
                    type: object
                    description: Service-specific response data
                  receipt:
                    type: object
                    description: Payment receipt

  # ========================================
  # POLICY ENGINE (UNIFIED)
  # ========================================

  /api/policy/check:
    post:
      operationId: checkPolicy
      summary: Check transaction policy
      description: |
        CRITICAL: Call BEFORE any purchase/service request.
        Supports BOTH transaction types via transactionType parameter.
        
        **For agent-to-merchant:**
        - Set transactionType: "agent-to-merchant"
        - Include: product_id, price, merchant, category
        
        **For agent-to-agent:**
        - Set transactionType: "agent-to-agent"
        - Include: serviceType, recipientAgentId, buyerAgentId, price
        
        If allowed=false, DO NOT proceed with transaction.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - price
                - user_email
                - transactionType
              properties:
                user_email:
                  type: string
                  format: email
                  example: "agent@example.com"
                transactionType:
                  type: string
                  enum: ["agent-to-merchant", "agent-to-agent", "all"]
                  example: "agent-to-merchant"
                  description: Type of transaction being checked
                
                # Common fields
                price:
                  type: number
                  example: 50.00
                
                # Agent-to-merchant fields
                product_id:
                  type: string
                merchant:
                  type: string
                  example: "Amazon"
                category:
                  type: string
                  example: "Electronics"
                
                # Agent-to-agent fields
                serviceType:
                  type: string
                  example: "scrape"
                  description: Service being requested
                recipientAgentId:
                  type: string
                  example: "agent://scraper.service/v1"
                  description: Agent providing the service
                buyerAgentId:
                  type: string
                  example: "agent://buyer.agent/v1"
                  description: Agent requesting the service
      responses:
        '200':
          description: Policy check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  allowed:
                    type: boolean
                    description: If false, DO NOT proceed
                  reason:
                    type: string
                  requiresApproval:
                    type: boolean
                  flaggedForReview:
                    type: boolean
                  matchedPolicies:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        passed:
                          type: boolean
                        reason:
                          type: string

  /api/policy/spending:
    post:
      operationId: getSpending
      summary: Get spending summary
      description: Get user spending across all transaction types
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
      responses:
        '200':
          description: Spending summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                  spending:
                    type: object
                    properties:
                      daily:
                        type: number
                      weekly:
                        type: number
                      monthly:
                        type: number

  # ========================================
  # UTILITY ENDPOINTS
  # ========================================

  /health:
    get:
      operationId: healthCheck
      summary: Health check
      description: Check if API is running
      security: []
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"

  /api/facilitator/health:
    get:
      operationId: facilitatorHealth
      summary: Facilitator health
      description: Check x402 facilitator service status
      security: []
      responses:
        '200':
          description: Facilitator is operational
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  service:
                    type: string
                  timestamp:
                    type: string

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token from /api/auth/generate-token.
        Include as: Authorization: Bearer {token}

security:
  - BearerAuth: []
