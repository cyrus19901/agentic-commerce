openapi: 3.1.0
info:
  title: Agentic Commerce API
  description: |
    API for ChatGPT shopping assistant with policy enforcement.
    
    IMPORTANT CONTEXT FOR CHATGPT:
    
    **Available Products:**
    IMPORTANT: You have 30+ products available in the catalog. ALWAYS use searchProducts to find items.
    Available inventory includes:
    - Office supplies: notebooks ($19.99), pens ($14.99), sticky notes ($12.99), desk organizers ($34.99)
    - Office furniture: ergonomic chairs ($249.99), standing desks ($179.99), monitor stands ($79.99)
    - Electronics: headphones ($199.99), keyboards ($129.99), mice ($49.99), webcams ($149.99), USB hubs ($59.99)
    - Bags & purses: leather notebooks ($28-$42), briefcases, backpacks ($89.99), crossbody purses
    - Travel: luggage tags ($18.99), passport holders ($27.99), travel adapters ($32.99)
    - Jewelry: necklaces ($79-$89), rings ($125), bracelets ($149), earrings ($199)
    
    When users ask for products, SEARCH FIRST using searchProducts - products are available!
    
    **Policy Enforcement:**
    Before completing any purchase, you MUST call checkPolicy to verify the transaction complies with company policies.
    Policies may restrict:
    - Transaction amounts (maximum per transaction)
    - Budget limits (daily, weekly, or monthly spending caps)
    - Merchant restrictions (allowed or blocked merchants)
    - Category restrictions (allowed or blocked product categories)
    - Time-based restrictions (allowed times of day or days of week)
    - Agent-based restrictions (which AI agents can make purchases)
    - Purpose-based restrictions (transaction purposes)
    
    If a policy check fails, you MUST inform the user and explain why the purchase cannot proceed.
    If a policy check requires approval, you MUST inform the user that manual approval is needed.
    
    **User Authentication:**
    - Ask for user's email naturally in conversation if not already provided
    - Include "user_email" field in ALL API requests
    - Example: {"query": "notebook", "user_email": "cyrus19901@gmail.com"}
    - The system uses email for authentication and policy checks
    
    **Workflow (Traditional):**
    1. User asks for a product → Use searchProducts to find matching items
    2. User wants to purchase → Call checkPolicy first to verify compliance
    3. If policy check passes → Call initiateCheckout to create payment session
    4. After payment → Call completeCheckout to finalize purchase
    
    **Workflow (ACP-Compliant):**
    1. User asks for a product → Use searchProducts to find matching items
    2. User wants to purchase → Call /checkout (includes automatic policy check)
    3. After payment → Use /delegate-payment if needed
    4. Track order → Use /fulfillment endpoints
    
    **Stripe Agents Toolkit:**
    - Use createPaymentLink to create payment links dynamically
    - Use createProduct and createPrice for dynamic product creation
    - These work alongside traditional checkout flow
    
    Always check policies BEFORE initiating checkout!
  version: 1.0.0
servers:
  - url: https://2ba9-71-212-131-94.ngrok-free.app
    description: Local development server via ngrok tunnel

paths:
  # ============================================================================
  # AGENT-TO-AGENT SERVICE ENDPOINTS
  # ============================================================================
  
  /api/registry/agents:
    get:
      operationId: discoverAgents
      summary: Discover available agents and their services
      description: |
        Find agents that offer specific services. Use this to discover what agents
        are available before requesting their services.
        
        Example services: data-scraping, api-calls, computation, data-processing
      parameters:
        - name: service
          in: query
          schema:
            type: string
          description: Filter agents by service type (e.g., "data-scraping")
        - name: user_email
          in: query
          required: true
          schema:
            type: string
            format: email
          description: User's email for authentication
      responses:
        '200':
          description: List of available agents
          content:
            application/json:
              schema:
                type: object
                properties:
                  agents:
                    type: array
                    items:
                      type: object
                      properties:
                        agentId:
                          type: string
                          example: "agent://seller-test/v1"
                        name:
                          type: string
                        services:
                          type: array
                          items:
                            type: string
                        serviceDescription:
                          type: string
                        acceptedCurrencies:
                          type: array
                          items:
                            type: string
  
  /api/agent/services/{serviceType}:
    post:
      operationId: requestAgentServiceDirect
      summary: Request a service from another agent (Agent-to-Agent transaction)
      description: Request agent service using x402 protocol. Returns 402 for payment, then executes service after payment proof submitted.
      parameters:
        - name: serviceType
          in: path
          required: true
          schema:
            type: string
            enum: [data-scraping, api-calls, computation, data-processing]
          description: Type of service to request
          example: "data-scraping"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
                  description: User's email for authentication and policy checks
                url:
                  type: string
                  description: For data-scraping - URL to scrape
                extractFields:
                  type: array
                  items:
                    type: string
                  description: For data-scraping - Fields to extract
              example:
                user_email: "user@example.com"
                url: "https://example.com"
                extractFields: ["title", "description"]
      responses:
        '402':
          description: Payment Required - USDC payment needed on Solana
          headers:
            PAYMENT-REQUIRED:
              schema:
                type: string
              description: Base64url encoded x402 payment requirement
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "PAYMENT_REQUIRED"
                  requirement:
                    type: object
                    description: Payment requirement details
                    properties:
                      protocol:
                        type: string
                        example: "x402"
                      amount:
                        type: string
                        example: "1000000"
                        description: Amount in lamports (1 USDC = 1,000,000 lamports)
                      mint:
                        type: string
                        example: "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"
                        description: USDC token mint address
                      network:
                        type: string
                        example: "solana:devnet"
                      payTo:
                        type: string
                        description: Seller's USDC token account
        '200':
          description: Service completed successfully (after payment verification)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  service:
                    type: string
                  data:
                    type: object
                  message:
                    type: string
        '403':
          description: Policy violation - Transaction not allowed
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                  reason:
                    type: string
                  matchedPolicies:
                    type: array

  # ============================================================================
  # TRADITIONAL SHOPPING ENDPOINTS
  # ============================================================================
  
  /api/auth/create-user:
  /api/auth/create-user:
    post:
      operationId: createUser
      summary: Create a new user account
      description: |
        Create a new user account or retrieve existing user. 
        Call this FIRST when a new user wants to start shopping.
        Returns user details that can be used to generate authentication token.
      security: []  # No auth required for user creation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: User's email address
                  example: "user@example.com"
                name:
                  type: string
                  description: User's full name (optional)
                  example: "John Doe"
      responses:
        '200':
          description: User created or retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      email:
                        type: string
                      name:
                        type: string
                  message:
                    type: string

  /api/auth/generate-token:
    post:
      operationId: generateToken
      summary: Generate authentication token
      description: |
        Generate a JWT token for authentication.
        Call this AFTER creating a user to get their access token.
        Store this token and use it for all subsequent API calls.
      security: []  # No auth required for token generation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  description: User's email address
                  example: "user@example.com"
      responses:
        '200':
          description: Token generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  token:
                    type: string
                    description: JWT token for authentication (use in Authorization header as "Bearer {token}")
                  userId:
                    type: string
                  email:
                    type: string
                  name:
                    type: string
                  expiresIn:
                    type: string
                    description: Token expiration period
                  message:
                    type: string

  /api/products/search:
    post:
      operationId: searchProducts
      summary: Search for products in the store
      description: |
        Search for products. Categories: Office Supplies, Electronics, Bags & Purses, Travel.
        Examples: "notebook", "chair", "headphones", "backpack". Products include imageUrl for display.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - query
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
                  description: User's email address (REQUIRED for all requests)
                  example: "cyrus19901@gmail.com"
                query:
                  type: string
                  description: Search query (e.g., "leather notebook", "vintage lamp")
                max_price:
                  type: number
                  description: Maximum price filter
                category:
                  type: string
                  description: Product category filter
                limit:
                  type: integer
                  description: Number of results to return (default 10)
                  default: 10
      responses:
        '200':
          description: Successful search
          content:
            application/json:
              schema:
                type: object
                properties:
                  products:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        title:
                          type: string
                        description:
                          type: string
                        price:
                          type: number
                        currency:
                          type: string
                        merchant:
                          type: string
                        merchantId:
                          type: string
                        url:
                          type: string
                        imageUrl:
                          type: string
                          description: Product image URL (HTTPS, publicly accessible)
                          example: "https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=400&h=400&fit=crop"
                        category:
                          type: string
                        inStock:
                          type: boolean

  /api/policy/check:
    post:
      operationId: checkPolicy
      summary: Check if purchase complies with policies
      description: |
        CRITICAL: Call BEFORE checkout. Verifies compliance with policies.
        If "allowed: false", do NOT proceed. If "requiresApproval: true", inform user.
        Include user_email in request body.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - product_id
                - price
                - merchant
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
                  description: User's email address (REQUIRED)
                  example: "cyrus19901@gmail.com"
                user_id:
                  type: string
                  description: User identifier (OPTIONAL - extracted from user_email)
                product_id:
                  type: string
                  description: Product identifier
                price:
                  type: number
                  description: Product price
                merchant:
                  type: string
                  description: Merchant/shop name
                category:
                  type: string
                  description: Product category (e.g., "Office Supplies", "Electronics", "Bags & Purses", "Travel & Accessories")
                agent_name:
                  type: string
                  description: Name of the AI agent making the request (optional, for agent-based policies)
                agent_type:
                  type: string
                  description: Type of AI agent (optional, for agent-based policies)
                time_of_day:
                  type: string
                  description: Time of day in HH:MM format (optional, for time-based policies)
                day_of_week:
                  type: integer
                  description: Day of week (0-6, Sunday=0) (optional, for time-based policies)
                recipient_agent:
                  type: string
                  description: Recipient agent name (optional, for agent-based policies)
                purpose:
                  type: string
                  description: Transaction purpose (optional, for purpose-based policies)
      responses:
        '200':
          description: Policy check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  allowed:
                    type: boolean
                    description: Whether the purchase is allowed. If false, do NOT proceed with checkout.
                  reason:
                    type: string
                    description: Explanation of why the purchase is allowed or denied
                  requiresApproval:
                    type: boolean
                    description: If true, manual approval is required before purchase can proceed
                  flaggedForReview:
                    type: boolean
                    description: If true, the transaction should be flagged for review even if allowed
                  matchedPolicies:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                        name:
                          type: string
                        passed:
                          type: boolean
                        reason:
                          type: string

  /api/policy/spending:
    post:
      operationId: getSpending
      summary: Get user spending summary
      description: Retrieve user's spending for different time periods
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
                  description: User's email address (REQUIRED)
                  example: "cyrus19901@gmail.com"
                user_id:
                  type: string
                  description: User identifier (OPTIONAL - extracted from user_email)
      responses:
        '200':
          description: Spending summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                  spending:
                    type: object
                    properties:
                      daily:
                        type: number
                      weekly:
                        type: number
                      monthly:
                        type: number

  /api/checkout/initiate:
    post:
      operationId: initiateCheckout
      summary: Initiate checkout process
      description: |
        Create a checkout session for a product. 
        NOTE: If Stripe is not configured, this returns a mock checkout URL pointing to the product's direct purchase link.
        The checkout service is functional - use the returned checkout_url to proceed with purchase.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - product_id
                - amount
                - product_name
                - merchant
                - user_email
              properties:
                user_email:
                  type: string
                  format: email
                  description: User's email address (REQUIRED)
                  example: "cyrus19901@gmail.com"
                user_id:
                  type: string
                  description: User identifier (OPTIONAL - extracted from user_email if not provided)
                product_id:
                  type: string
                product_name:
                  type: string
                  description: Name of the product
                amount:
                  type: number
                merchant:
                  type: string
                category:
                  type: string
                product_url:
                  type: string
                  description: URL to the product page
                product_image_url:
                  type: string
                  description: URL to the product image
      responses:
        '200':
          description: Checkout session created
          content:
            application/json:
              schema:
                type: object
                properties:
                  checkout_session_id:
                    type: string
                  checkout_url:
                    type: string
                  expires_at:
                    type: string

  /api/checkout/complete:
    post:
      operationId: completeCheckout
      summary: Complete checkout
      description: Finalize a purchase after payment
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - user_email
              properties:
                session_id:
                  type: string
                user_email:
                  type: string
                  format: email
                  description: User's email address (REQUIRED)
                  example: "cyrus19901@gmail.com"
                user_id:
                  type: string
                  description: User identifier (OPTIONAL - extracted from user_email)
      responses:
        '200':
          description: Purchase completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  message:
                    type: string
                  invoice:
                    type: object
                    properties:
                      id:
                        type: string
                      orderId:
                        type: string
                      amount:
                        type: number
                      status:
                        type: string

  /api/chatgpt-agent/wallet:
    post:
      summary: Get or create Solana wallet for agent-to-agent payments
      description: |
        Creates and returns a Solana wallet for the user to enable agent-to-agent transactions.
        The wallet is used to hold USDC for paying other agents.
        Includes funding instructions for testnet/mainnet.
      operationId: getChatGPTWallet
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_email:
                  type: string
                  description: User's email address
              required:
                - user_email
      responses:
        '200':
          description: Wallet information
          content:
            application/json:
              schema:
                type: object
                properties:
                  wallet:
                    type: object
                    properties:
                      publicKey:
                        type: string
                        description: Solana public key
                      tokenAccount:
                        type: string
                        description: USDC token account address
                      network:
                        type: string
                        enum: [devnet, mainnet-beta]
                      balances:
                        type: object
                        properties:
                          sol:
                            type: number
                            description: SOL balance
                          usdc:
                            type: number
                            description: USDC balance
                      fundingInstructions:
                        type: object
                        properties:
                          sol:
                            type: string
                          usdc:
                            type: string

  /api/chatgpt-agent/request-service:
    post:
      summary: Request a service from another agent (ChatGPT as buyer)
      description: ChatGPT acts as buyer agent. Automatically handles payment flow, executes USDC payment on Solana, and returns service result.
      operationId: requestAgentServiceAuto
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_email:
                  type: string
                  description: User's email address
                agentId:
                  type: string
                  description: Agent ID to request service from (e.g., "agent://seller-test/v1")
                serviceType:
                  type: string
                  description: Type of service to request
                  enum:
                    - data-scraping
                    - api-calling
                    - computation
                serviceParams:
                  type: object
                  description: Service-specific parameters
                  properties:
                    url:
                      type: string
                      description: For data-scraping, the URL to scrape
                    extractFields:
                      type: array
                      items:
                        type: string
                      description: Fields to extract from the page
                    apiUrl:
                      type: string
                      description: For api-calling, the API URL to call
                    method:
                      type: string
                      description: HTTP method (GET, POST, etc.)
                    payload:
                      type: object
                      description: Request payload for API call
              required:
                - user_email
                - agentId
                - serviceType
      responses:
        '200':
          description: Service completed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  service:
                    type: string
                    description: Service type that was executed
                  agent:
                    type: string
                    description: Agent ID that provided the service
                  payment:
                    type: object
                    properties:
                      amount:
                        type: number
                        description: Amount paid in USDC
                      currency:
                        type: string
                        enum: [USDC]
                      txSignature:
                        type: string
                        description: Solana transaction signature
                      explorerUrl:
                        type: string
                        description: Link to view transaction on Solana explorer
                  result:
                    type: object
                    description: Service-specific result data
        '400':
          description: Bad request (missing fields, no wallet, etc.)
        '402':
          description: Payment required (should not happen as payment is automatic)
        '404':
          description: User or agent not found
        '500':
          description: Service request error

  /api/registry/agents:
    get:
      summary: List all registered agents
      description: |
        Discover available agents in the registry.
        Use this to find agents that ChatGPT can interact with for agent-to-agent transactions.
      operationId: listAgents
      parameters:
        - name: serviceType
          in: query
          schema:
            type: string
          description: Filter by service type
        - name: verified
          in: query
          schema:
            type: boolean
          description: Filter by verification status
      responses:
        '200':
          description: List of registered agents
          content:
            application/json:
              schema:
                type: object
                properties:
                  agents:
                    type: array
                    items:
                      type: object
                      properties:
                        agentId:
                          type: string
                          description: Unique agent identifier
                        name:
                          type: string
                        description:
                          type: string
                        serviceType:
                          type: string
                          description: Type of service offered
                        pricing:
                          type: object
                          properties:
                            basePrice:
                              type: number
                              description: Base price in USDC
                        capabilities:
                          type: array
                          items:
                            type: string
                        endpoint:
                          type: string
                          description: Agent API endpoint
                        active:
                          type: boolean
                        verified:
                          type: boolean

components:
  schemas: {}
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtained from /api/auth/generate-token.
        Include in Authorization header as: Bearer {token}

security: []
  # Authentication is optional. For ChatGPT integration:
  # - Either configure a Bearer token in ChatGPT (for single-user testing)
  # - Or leave authentication empty and the API will use user email from requests


